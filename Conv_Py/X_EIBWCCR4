//EIBWCCR4  JOB 224T,'EIBWCCR4',CLASS=A,MSGCLASS=X,MSGLEVEL=(1,1),
//          NOTIFY=&SYSUID
/*JOBPARM S=S1M1
//***********************************************************
//* DELETE OUTPUT FILES
//* LAST MODIFY : 25 APR 2006 ESMR2006-0563
//* LAST MODIFY : 28 APR 2006 ESMR2005-0765
//* MAA3 SMR 2006-1338 : 18 SEP 2006
//*               MAPPING OF BUMI/NRCC FROM ACC LVL CUSTCODE
//* AAB  SMR 2010-4345 : 10 DEC 2010
//*               DERIVE BGC FROM CUSTCODE & PURPOSE & ORG
//*               TYPE FOR "CORPORATE" RECORDS AND DEFAULT
//*               "11" FOR "INDIVIDUAL" RECORDS
//***********************************************************
//DELETE   EXEC PGM=IEFBR14
//DD1      DD DSN=SAP.PBB.CCRIS1.CCRISIND,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,
//            SPACE=(CYL,1,RLSE)
//DD2      DD DSN=SAP.PBB.CCRIS1.CCRISCOR,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,
//            SPACE=(CYL,1,RLSE)
//DD3      DD DSN=SAP.PBB.CCRIS1.CCRISOWN,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,
//            SPACE=(CYL,1,RLSE)
//DD4      DD DSN=SAP.PBB.CCRIS1.DATE,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,
//            SPACE=(CYL,1,RLSE)
//*
//SAS6094  EXEC SAS609
//BNM      DD DSN=SAP.PBB.MNILN(0),DISP=SHR
//LIMIT    DD DSN=SAP.PBB.MNILIMT(0),DISP=SHR
//DEPOSIT  DD DSN=SAP.PBB.MNITB(0),DISP=SHR
//CISDP    DD DSN=SAP.PBB.CISBEXT.DP,DISP=SHR
//CISLN    DD DSN=SAP.PBB.CISBEXT.LN,DISP=SHR
//CICODMT  DD DSN=RBP2.B033.UNLOAD.CICODMT.FB,DISP=SHR
//BTRSA    DD DSN=SAP.PBB.BTRADE.SASDATA,DISP=SHR
//PGM      DD DSN=SAP.BNM.PROGRAM,DISP=SHR
//ELDS     DD DSN=SAP.ELDS.ELAA(0),DISP=SHR
//ELDS1    DD DSN=SAP.ELDS.ELHP(0),DISP=SHR
//ELDSRVX  DD DSN=SAP.ELDS.EREV(0),DISP=SHR
//CCRISX   DD DSN=SAP.BNM.PROGRAM(CCRISX),DISP=SHR
//CCRISP   DD DSN=SAP.PBB.CCRIS.SPLIT,DISP=SHR
//CISID    DD DSN=RBP2.B033.UNLOAD.ALLALIAS.FB,DISP=SHR
//CICINDT  DD DSN=RBP2.B033.UNLOAD.CICINDT.FB,DISP=SHR
//POSTCD   DD DSN=SAP.PBB.BDS.POSTCODE,DISP=SHR
//SASLIST   DD SYSOUT=A
//OUTPUT1   DD DSN=SAP.PBB.CCRIS1.CCRISIND,
//          DISP=(NEW,CATLG),
//          SPACE=(CYL,(300,150),RLSE),
//          UNIT=(SYSDA,5),
//          DCB=(LRECL=2300,RECFM=FB,BLKSIZE=0,BUFNO=10)
//OUTPUT2   DD DSN=SAP.PBB.CCRIS1.CCRISCOR,
//          DISP=(NEW,CATLG,DELETE),
//          SPACE=(CYL,(80,50),RLSE),
//          UNIT=SYSDA,
//          DCB=(LRECL=1500,RECFM=FB,BLKSIZE=0,BUFNO=10)
//OUTPUT3   DD DSN=SAP.PBB.CCRIS1.CCRISOWN,
//          DISP=(NEW,CATLG,DELETE),
//          SPACE=(CYL,(20,10),RLSE),
//          UNIT=SYSDA,
//          DCB=(LRECL=800,RECFM=FB,BLKSIZE=0,BUFNO=10)
//OUTDATE   DD DSN=SAP.PBB.CCRIS1.DATE,
//          DISP=(NEW,CATLG,DELETE),
//          SPACE=(CYL,(1,1),RLSE),
//          UNIT=SYSDA,
//          DCB=(LRECL=80,RECFM=FB,BLKSIZE=0,BUFNO=10)
//SORTWK01  DD UNIT=SYSDA,SPACE=(CYL,(1000,500))
//SORTWK02  DD UNIT=SYSDA,SPACE=(CYL,(1000,500))
//SORTWK03  DD UNIT=SYSDA,SPACE=(CYL,(1000,500))
//SORTWK04  DD UNIT=SYSDA,SPACE=(CYL,(1000,500))
//SORTWK05  DD UNIT=SYSDA,SPACE=(CYL,(1000,500))
//SYSIN     DD *

PROC FORMAT;
   VALUE $PROF
     '001'  = 'ACCOUNTANT'
     '002'  = 'ARCHITECT'
     '003'  = 'BANKER'
     '004'  = 'OFFICE/BUSINESS EXEC'
     '005'  = 'CLERICAL/NONCLERICAL'
     '006'  = 'DIRECTOR'
     '007'  = 'DOCTOR'
     '008'  = 'DENTIST'
     '009'  = 'ENGINEER'
     '010'  = 'GOVERNMENT SERVANTS'
     '011'  = 'FACTORY WORKER'
     '012'  = 'HOUSEWIFE'
     '013'  = 'LAWYER'
     '014'  = 'MECHANICS'
     '015'  = 'SELF EMPLOYED'
     '016'  = 'STUDENT'
     '017'  = 'TEACHER/LECTURER'
     '018'  = 'TECHNICIAN'
     '019'  = 'SURVEYOR'
     '020'  = 'OTHER PROFESSIONAL'
     '021'  = 'ALL OTHERS'
     '022'  = 'NO AVAILABLE'
     '   '  = 'NO AVAILABLE';
*;
%INC PGM(PBBDPFMT);
DATA DATES;
   SET BNM.REPTDATE;
   SELECT(DAY(REPTDATE));
   WHEN (8)  DO; SDD = 1;  WK = '1'; WK1 = '4'; END;
   WHEN(15)  DO; SDD = 9;  WK = '2'; WK1 = '1'; END;
   WHEN(22)  DO; SDD = 16; WK = '3'; WK1 = '2'; END;
     OTHERWISE DO; SDD = 23; WK = '4'; WK1 = '3'; END;
   END;
   MM = MONTH(REPTDATE);
   IF WK = '1' THEN DO;
      MM1 = MM - 1;
      IF MM1 = 0 THEN MM1 = 12;
   END;
   ELSE MM1 = MM;
   DAYS = DAY(REPTDATE);
   MONTHS = MONTH(REPTDATE);
   YEARS = YEAR(REPTDATE);
   SDATE = MDY(MONTHS,DAYS,YEARS);
   IDATE = MDY(MONTHS,1,YEARS);
   CALL SYMPUT('NOWK',PUT(WK,$1.));
   CALL SYMPUT('NOWK1',PUT(WK1,$1.));
   CALL SYMPUT('REPTMON',PUT(MM,Z2.));
   CALL SYMPUT('REPTMON1',PUT(MM1,Z2.));
   CALL SYMPUT('REPTYEAR',PUT(REPTDATE,YEAR4.));
   CALL SYMPUT('RDATE',PUT(REPTDATE,DDMMYY8.));
   CALL SYMPUT('REPTDAY',PUT(DAY(REPTDATE),Z2.));
   CALL SYMPUT('SDATE',PUT(SDATE,Z5.));
   CALL SYMPUT('IDATE',PUT(IDATE,Z5.));
   FILE OUTDATE;
      PUT @0001 DAYS       Z2.
          @0003 '/'
          @0004 MONTHS     Z2.
          @0006 '/'
          @0007 YEARS       4.;
RUN;
*;
PROC PRINT DATA=DATES;
*;
DATA CISID;
   INFILE CISID;
   INPUT @005 CUSTNO     20.
         @092 IDNUM     $37.
         ;
   COUNT=1;
RUN;

PROC SORT DATA=CISID;BY CUSTNO;RUN;
PROC SUMMARY DATA=CISID NWAY;
BY CUSTNO;
VAR COUNT;
OUTPUT OUT=CISIDSUM SUM=;
RUN;

PROC TRANSPOSE DATA=CISID OUT=CISIDSUM1;BY CUSTNO;VAR IDNUM;RUN;

DATA CISIDSUM1;
   MERGE CISIDSUM1(IN=A) CISIDSUM(IN=B);BY CUSTNO;
   IF A;
RUN;

DATA CISIDNUM(KEEP=CUSTID CUSTNO);
   FORMAT CUSTID $100.;
   SET CISIDSUM1;
   ARRAY COL(*) COL: ;
   I=1;
   DO WHILE (I <= COUNT);
      IF I=1 THEN DO;
         CUSTID=COL1;
      END;
      ELSE DO;
         CUSTID=COMPRESS(CUSTID||'|'||COL(I));
      END;
   I+1;
   END;
RUN;

DATA CICINDT;
   INFILE CICINDT;
   INPUT @001 CUSTNO               11.
         @021 PR_CTRY              $2.
         @023 EMPLOYER_NAME      $150.
         @173 EMPLOY_TYPE_CD       $3.
         @183 EMPLOY_SECTOR_CD     $5.
         @193 EMPLOY_LSTMNT_DT    $10.
         @203 EMPLOY_LSTMNT_TM     $8.
         ;
RUN;
PROC SORT DATA=CICINDT NODUPKEY; BY CUSTNO; RUN;

PROC SORT DATA=CISDP.DEPOSIT OUT=CISDEP(DROP=BRANCH);
     BY CUSTNO ACCTNO;
     WHERE CACCCODE NOT IN ('013','014','016','017','018','019',
     '021','022','023','024','025','027');
*;
DATA CURRENT;
   LENGTH PRODCD $5.;
   SET DEPOSIT.CURRENT;
   PRODCD=PUT(PRODUCT, CAPROD.);
   DROP MAILCODE;
RUN;
PROC SORT DATA=CURRENT OUT=CURRENT(DROP=APPRLIMT) NODUPKEY;
   BY ACCTNO;
   WHERE PRODCD NE 'N';
*;
DATA BTRSA;
     SET BTRSA.MAST&REPTDAY&REPTMON;
     WHERE ACCTNO > 0 AND SETTLED NE 'S';
     LOANTYPE=000;
     IF FICODE > 0;
     IF RETAILID='C' THEN LOANTYPE=999;
     PRODUCT=LOANTYPE;
     BRANCH=FICODE;
     PENDBRH=FICODE;
     MNISECT=SECTOR;
*;
PROC SORT; BY ACCTNO;
*;
PROC SORT DATA=BNM.LNACCT OUT=BTACC; BY ACCTNO;
*;
DATA BTRSA;
     MERGE BTRSA(IN=A) BTACC(IN=B); BY ACCTNO;
     IF A OR 2460000000<=ACCTNO<=2490000000;
     NOTENO=0; PAIDIND=' '; REVERSED=' ';
     IF PRODUCT= . THEN PRODUCT = 0;
     IF BRANCH = . THEN DO;
        BRANCH = ACCBRCH;
        PENDBRH= ACCBRCH;
     END;
*;
PROC SORT DATA=BNM.LNNOTE OUT=LOAN(RENAME=SECTOR=MNISECT DROP=MAILCODE);
     BY ACCTNO NOTENO;
*;
DATA LOAN;
     SET LOAN;

     IF  COSTCTR=8044 THEN DO;
         BRANCH=902; PENDBRH=902;
     END;
     IF  COSTCTR=8048 THEN DO;
         BRANCH=903; PENDBRH=903;
     END;

     CUSTCODE=CUSTCDR;
     CHKDT='31AUG04'D;
     IF APPLDATE=.  THEN APPLDT=0;
     IF APPLDATE=0  THEN APPLDT=0;
     IF APPLDATE > 0
        THEN APPLDT=INPUT(SUBSTR(PUT(APPLDATE,Z11.),1,8),MMDDYY8.);

     IF /* ACCTNO > 8000000000 AND */
       (LOANTYPE IN (128,130,380,381,700,705) AND
        LSTTRNCD IN (658,662) AND APPLDT NE . ) OR
        LOANTYPE IN (981,982,983,991,992,993) THEN DO;
        IF       CHKDT > APPLDT               THEN DELETE;
     END;

     IF    REVERSED NE 'Y'  AND NOTENO NE .     AND
           BORSTAT NOT IN ('W','Z');
*;
PROC SORT DATA=LOAN; BY ACCTNO;
*;
PROC SORT DATA=LIMIT.OVERDFT OUT=OVERDFT(RENAME=PRODUCT=LOANTYPE)
     NODUPKEY; BY ACCTNO;
     WHERE OPENIND NOT IN ('B','C','P');
*;
DATA RELATION;
   SET CISDP.RELATION
       CISLN.RELATION;
       DROP CUSTNO2;
*;
PROC SORT; BY CUSTNO ACCTNO;
*;
PROC SORT DATA=CISLN.LOAN OUT=CISLOAN(DROP=BRANCH); BY CUSTNO ACCTNO;
     WHERE CACCCODE NOT IN ('013','014','016','017','018','019',
     '021','022','023','024','025','027');
*;
DATA CURRENT(DROP=SECTOR);
   MERGE CURRENT(IN=A) OVERDFT(KEEP=ACCTNO RISKCODE);
   BY ACCTNO;
   IF A;
   IF CLOSEDT NE . AND CLOSEDT GT 0   THEN DO;
      PROCYEAR = SUBSTR(PUT(CLOSEDT,Z11.),5,4);
      PROCMONT = SUBSTR(PUT(CLOSEDT,Z11.),1,2);
   END;
   MNISECT=PUT(SECTOR,$6.);
   IF OPENIND NOT IN ('B','C','P')  THEN OUTPUT;  ELSE
   IF OPENIND IN ('B','C','P')  AND
      ((PROCYEAR EQ &REPTYEAR) AND (PROCMONT EQ &REPTMON))
                                    THEN OUTPUT;
*;
DATA CURRENT;
   SET CURRENT;
   IF OPENIND IN ('B','C','P') AND
      CLOSEDT NE . AND CLOSEDT GT 0   THEN DO;
      IF (PROCYEAR EQ OPENYEAR) AND (PROCMONT EQ OPENMONT) THEN DELETE;
   END;
RUN;
DATA LOAN;
   SET LOAN;
   IF LASTTRAN NE . AND LASTTRAN GT 0   THEN DO;
      PROCYEAR = SUBSTR(PUT(LASTTRAN,Z11.),5,4);
      PROCMONT = SUBSTR(PUT(LASTTRAN,Z11.),1,2);
      ISSUYEAR = SUBSTR(PUT(ISSUEDT,Z11.),5,4);
      ISSUMONT = SUBSTR(PUT(ISSUEDT,Z11.),1,2);
   END;
   IF PAIDIND EQ 'P' AND
      ((PROCYEAR EQ &REPTYEAR) AND (PROCMONT EQ &REPTMON))
                                    THEN OUTPUT; ELSE
   IF PAIDIND NE 'P'   THEN OUTPUT;
*;
DATA LOAN;
   SET LOAN;
   IF PAIDIND = 'P' AND LASTTRAN NE . AND LASTTRAN GT 0   THEN DO;
      IF (PROCYEAR EQ ISSUYEAR) AND (PROCMONT EQ ISSUMONT) THEN DELETE;
   END;
RUN;
PROC SORT; BY ACCTNO NOTENO;
*;
DATA CCRISX;
   INFILE CCRISX;
   INPUT @004  ACCTNO   10.
         @017  NOTENO    5.;
*;
PROC SORT; BY ACCTNO NOTENO;
*;
DATA LOAN;
   MERGE LOAN CCRISX(IN=A); BY ACCTNO NOTENO;
   IF A  THEN DELETE;
*;
DATA LOANA;
   MERGE RELATION CISLOAN(IN=A); BY CUSTNO ACCTNO;
   IF CITIZEN IN ('MY') AND NEWICIND NOT IN ('IC','ML','PL')
      AND INDORG='I' THEN NEWIC = ' ';
   IF A;
*;
PROC SORT DATA=LOANA; BY ACCTNO;
*;
DATA ELDS;
   SET ELDS.ELBNMAX
       ELDS1.ELHPAX;
   KEEP ACCTNO BRANCH PRODUCT CUSTCODE COSTCTR AANO;
   WHERE &IDATE<=AADATE<=&SDATE AND BRANCH LT 3000;
   IF ACCTNO IN (.,0) THEN
      ACCTNO = COMPRESS(ACCTNO1,'0123456789','K');
   IF TRANBRNO NOT IN (.,0) THEN DO;
      BRANCH  = TRANBRNO;
      COSTCTR = TRANBRNO;
   END;
   IF PRODUCT IN (70:79) THEN BRANCH=903;
*;

 /* CHECK IS UNDISBURSED LOAN */
PROC SORT DATA=CCRISP.ELDS OUT=SPELDS NODUPKEY;BY AANO;
PROC SORT DATA=ELDS;BY AANO;
DATA ELDS (DROP=AANO);
   MERGE ELDS(IN=A) SPELDS(KEEP=AANO IN=B); BY AANO;
   IF A;
   IF B THEN DO;
      UNDISBURSE='Y';
   END;
RUN;

DATA LOAN;
   SET LOAN BTRSA ELDS;
*;
PROC SORT; BY ACCTNO;
*;
  /* REQUESTED BY ADELINE TO USER M2M RELATIONSHIP FOR JOIN  */
PROC SQL;
CREATE TABLE LOANX AS SELECT *
FROM LOAN A INNER JOIN LOANA B
ON A.ACCTNO=B.ACCTNO;
QUIT;
PROC DATASETS LIB=WORK;
  DELETE LOAN;
  CHANGE LOANX=LOAN;
RUN;
  /*
DATA LOAN;
   MERGE LOAN(IN=A) LOANA(IN=B); BY ACCTNO;
   IF A AND B;
  */
  /* REQUESTED BY ADELINE TO USER M2M RELATIONSHIP FOR JOIN - ENDS  */
*;
DATA LOANNEW (KEEP=ACCTNO NOCUSTOM);
   SET LOAN; BY ACCTNO;
   NOCUSTOM + 1;
   IF LAST.ACCTNO   THEN DO;
      OUTPUT LOANNEW;
      NOCUSTOM = 0;
   END;
*;
DATA LOAN;
   MERGE LOAN(IN=A) LOANNEW(IN=B); BY ACCTNO;
   IF A AND B;
*;
DATA LOAN;
   ARRAY TAXOLD(17) $ 1 TAXOLD1-TAXOLD17;
   ARRAY TAXOLT(17) $ 1 TAXOLT1-TAXOLT17;
   ARRAY TAXNEW(17) $ 1 TAXNEW1-TAXNEW17;
   ARRAY TAXNET(17) $ 1 TAXNET1-TAXNET17;
   SET LOAN;
   ACTY='LN';
   IF SECCUST = '901' THEN PRICUST = 'Y';
   ELSE                    PRICUST = 'N';
   IF (REVERSED NE 'Y') AND (NOTENO NE .) /* AND (PAIDIND NE 'P') */
   THEN DO;
      IF OLDIC = '  '   AND INDORG = 'I'   THEN DO;
            IF CACCCODE IN ('000','020') AND SECCUST = '901'  THEN DO;
               IF NEWICIND = 'IC'   THEN OLDIC = NEWIC;
         END;
      END;
      IF INPUT(OLDIC,$20.) IN ('0','.')   THEN OLDIC = ' ';
      IF OLDIC = NEWIC   THEN NEWIC = '  ';
      IF OLDIC = ' '  AND NEWIC NE ' '  THEN DO;
         OLDIC = NEWIC;
         NEWIC = ' ';
      END;
      IF OLDIC NE ' '   THEN DO;
         OLDIC = UPCASE(OLDIC);
         CHECK = '0123456789AKP';
         X = VERIFY(OLDIC,CHECK);
         IF X GT 0  THEN DO;
            J = 0;
            DO I = 1 TO 17;
               TAXOLT(I) = ' ';
            END;
            DO I = 1 TO 17;
               TAXOLD(I) = SUBSTR(OLDIC,I,1);
               IF ('0' <= TAXOLD(I) <= '9')  OR
                  ('A' <= TAXOLD(I) <= 'Z')
               THEN DO;
                  J + 1;
                  TAXOLT(J) = TAXOLD(I);
               END;
            END;
            OLDIC = TAXOLT(1)  || TAXOLT(2)  || TAXOLT(3)  ||
                    TAXOLT(4)  || TAXOLT(5)  || TAXOLT(6)  ||
                    TAXOLT(7)  || TAXOLT(8)  || TAXOLT(9)  ||
                    TAXOLT(10) || TAXOLT(11) || TAXOLT(12) ||
                    TAXOLT(13) || TAXOLT(14) || TAXOLT(15) ||
                    TAXOLT(16) || TAXOLT(17);
         END;
      END;
      IF NEWIC = '-N/A-               '         THEN NEWIC = ' ';
      ELSE IF NEWIC = 'N/A                 '    THEN NEWIC = ' ';
      ELSE IF INPUT(NEWIC,$17.) IN ('0','.')    THEN NEWIC = ' ';
      IF NEWIC NE ' ' THEN DO;
         NEWIC = UPCASE(NEWIC);
         CHECK = '0123456789';
         Y = VERIFY(NEWIC,CHECK);
         IF Y GT 0  THEN DO;
            J = 0;
            DO I = 1 TO 17;
               TAXNET(I) = ' ';
            END;
            DO I = 1 TO 17;
               TAXNEW(I) = SUBSTR(NEWIC,I,1);
               IF ('0' <= TAXNEW(I) <= '9')  OR
                  ('A' <= TAXNEW(I) <= 'Z')
               THEN DO;
                  J + 1;
                  TAXNET(J) = TAXNEW(I);
               END;
            END;
            NEWIC = TAXNET(1)  || TAXNET(2)  || TAXNET(3)  ||
                    TAXNET(4)  || TAXNET(5)  || TAXNET(6)  ||
                    TAXNET(7)  || TAXNET(8)  || TAXNET(9)  ||
                    TAXNET(10) || TAXNET(11) || TAXNET(12) ||
                    TAXNET(13) || TAXNET(14) || TAXNET(15) ||
                    TAXNET(16) || TAXNET(17);
         END;
      END;
   /* REPLACE OLDIC WITH NEWIC IF OLDIC HAS TRUNCATED VALUE */
      IF OLDIC NE NEWIC THEN DO;
      IF SUBSTR(OLDIC,1,7)=SUBSTR(NEWIC,1,7) OR
         SUBSTR(OLDIC,1,8)=SUBSTR(NEWIC,1,8) OR
         SUBSTR(OLDIC,1,9)=SUBSTR(NEWIC,1,9) OR
         SUBSTR(OLDIC,1,10)=SUBSTR(NEWIC,1,10)
         THEN OLDIC=' ';
      END;
      IF OLDIC = '  '    THEN DO;
         OLDIC = NEWIC;
         NEWIC = '  ';
      END;

      NEWIC = LEFT(NEWIC);
      BRANCH=PENDBRH;
      IF PENDBRH = 0  THEN BRANCH=NTBRCH;
      IF BRANCH  = 0  THEN BRANCH=ACCBRCH;
   END;
   MASCO_CD=OCCUPAT_MASCO_CD;
RUN;
   /** ESMR - 2009-161 MERGE WITH ELDS  **/
DATA ELDS;
  SET ELDS.ELNA4 (KEEP=JOB EMPNATUR EMPLOCAT ICPP ANNSUBTSALARY
      OCCUPAT_MASCO_CD INDUSTRIAL_SECTOR_CD)
      ELDS1.EHPA4  (KEEP=JOB EMPNATUR EMPLOCAT ICPP ANNSUBTSALARY
      OCCUPAT_MASCO_CD INDUSTRIAL_SECTOR_CD);
RUN;
PROC SORT DATA=ELDS NODUPKEYS; BY ICPP;
PROC SORT DATA=ELDSRVX.EREV OUT=APPL(KEEP=NEWID BNMSECT SEQNO);
     BY NEWID DESCENDING SEQNO;
     WHERE BNMSECT NOT IN (' ','-');
*;
PROC SORT DATA=APPL (KEEP=NEWID BNMSECT)
     NODUPKEYS; BY NEWID;
RUN;
DATA ELDS;
   MERGE APPL(IN=A RENAME=NEWID=ICPP) ELDS(IN=B);
   BY ICPP;
   WHERE ICPP NE ' ';
RUN;
DATA ELDS(DROP=ICPPX);
   LENGTH ICPP $17.;
   SET ELDS (RENAME=(ICPP=ICPPX));
   ICPP = ICPPX;
RUN;
*;
PROC SORT DATA=LOAN; BY NEWIC;
DATA LOAN;
   MERGE ELDS(IN=A RENAME=ICPP=NEWIC) LOAN(IN=B);
   BY NEWIC;
   IF B;
   IF MNISECT NOT IN ('1300','3110','3115','3113','3114','3219','3242',
                      '3250','3311','3313','3432','3551','3619','3852',
                      '3919','6110','6120','6130') THEN BNMSECT=MNISECT;
RUN;
  /* ELDS END  */
*;

PROC SORT DATA=CISIDNUM;BY CUSTNO;RUN;
PROC SORT DATA=LOAN;BY CUSTNO;RUN;

DATA CODM;
   INFILE CICODMT;
   INPUT @005  CUSTNO          11.
         @041  CORPSTATUS      $3.     /* CI-CODM-SALES */
         ;
RUN;
PROC SORT DATA=CODM NODUPKEY; BY CUSTNO; RUN;

DATA LOAN;
   MERGE LOAN(IN=A) CISIDNUM(IN=B) CODM CICINDT;
   BY CUSTNO;
   IF A;
RUN;

DATA INDLOAN
     CORLOAN;
   SET LOAN;
      IF INDORG = 'I' THEN DO;
         IF CACCCODE NOT IN ('001','002','013','016','017',
             '018','019','021','022','023','024','025','027')
                                           THEN OUTPUT INDLOAN;
      END;
      ELSE OUTPUT CORLOAN;
RUN;
DATA ALLLOAN;
   SET CORLOAN INDLOAN;
*;
   /** ESMR - 2009-161 MERGE WITH ELDS  **/
PROC DATASETS LIB=WORK;
DELETE LOAN;
RUN;
*;
DATA CISDEP;
   MERGE RELATION(IN=B) CISDEP(IN=A); BY CUSTNO ACCTNO;
   IF CITIZEN IN ('MY') AND NEWICIND NOT IN ('IC','ML','PL')
      AND INDORG='I' THEN NEWIC = ' ';
   IF A;
*;
PROC SORT DATA=CISDEP; BY ACCTNO;
*;
DATA CURRENT;
   SET CURRENT;
   TAKEN = 'N';
   IF (EXODDATE NE 0 OR TEMPODDT NE 0) AND (CURBAL LT 0)   THEN DO;
      IF EXODDATE NOT IN (0,.)   THEN DO;
         ODEDATE = INPUT(SUBSTR(PUT(EXODDATE,Z11.),1,8),MMDDYY8.);
         ODEDAYS = MDY(MONTH(ODEDATE),DAY(ODEDATE),YEAR(ODEDATE));
      END;
      ELSE ODEDAYS = 0;
      IF TEMPODDT NOT IN (0,.)   THEN DO;
         ODTDATE = INPUT(SUBSTR(PUT(TEMPODDT,Z11.),1,8),MMDDYY8.);
         ODTDAYS = MDY(MONTH(ODTDATE),DAY(ODTDATE),YEAR(ODTDATE));
      END;
      ELSE ODTDAYS = 0;
      IF ODEDAYS LE ODTDAYS   THEN ODDAYS = ODEDAYS;   ELSE
         ODDAYS = ODTDAYS;
      NODAYS = &SDATE - ODDAYS;
      IF NODAYS GT 89
      OR RISKCODE IN ('1','2','3','4') THEN TAKEN = 'Y';
   END;
*;
DATA OVERDFS;
   MERGE OVERDFT(IN=A) CURRENT(IN=B);
         BY ACCTNO;
   IF PRODUCT=105 THEN DELETE;
   IF ((A AND B AND APPRLIMT GT 1)  OR
       (B AND APPRLIMT LE 1 & CURBAL < 0 & BRANCH NE 998)) OR
        TAKEN = 'Y';
*;
PROC DATASETS LIB=WORK;
DELETE CURRENT;
RUN;
*;
DATA OVERDFT;
   MERGE OVERDFS(IN=A) CISDEP(IN=C);
         BY ACCTNO;
   IF A & C  THEN OUTPUT;
*;
PROC DATASETS LIB=WORK;
DELETE CISDEP OVERDFS;
RUN;
*;
   /** ESMR - 2009-161 MERGE WITH ELDS  **/
DATA ELDS;
  SET ELDS.ELNA4 (KEEP=JOB EMPNATUR EMPLOCAT ICPP ANNSUBTSALARY);
RUN;
PROC SORT DATA=ELDS NODUPKEYS; BY ICPP;
PROC SORT DATA=ELDSRVX.EREV OUT=APPL(KEEP=NEWID BNMSECT SEQNO);
     BY NEWID DESCENDING SEQNO;
     WHERE BNMSECT NOT IN (' ','-');
*;
PROC SORT DATA=APPL (KEEP=NEWID BNMSECT)
     NODUPKEYS; BY NEWID;
RUN;
DATA ELDS;
   MERGE APPL(IN=A RENAME=NEWID=ICPP) ELDS(IN=B);
   BY ICPP;
   WHERE ICPP NE ' ';
RUN;
DATA ELDS(DROP=ICPPX);
   LENGTH ICPP $17.;
   SET ELDS (RENAME=(ICPP=ICPPX));
   ICPP = ICPPX;
RUN;
*;
PROC SORT DATA=OVERDFT; BY NEWIC;
DATA OVERDFT;
   MERGE ELDS(IN=A RENAME=ICPP=NEWIC) OVERDFT(IN=B);
   BY NEWIC;
   IF B;
   IF MNISECT NOT IN ('1300','3110','3115','3113','3114','3219','3242',
                      '3250','3311','3313','3432','3551','3619','3852',
                      '3919','6110','6120','6130') THEN BNMSECT=MNISECT;
RUN;
  /* ELDS END  */

PROC SORT DATA=OVERDFT;BY CUSTNO;RUN;

DATA OVERDFT;
   MERGE OVERDFT(IN=A) CISIDNUM(IN=B) CODM CICINDT;
   BY CUSTNO;
   IF A;
RUN;

DATA INDOD
     COROD;
   ARRAY TAXOLD(17) $ 1 TAXOLD1-TAXOLD17;
   ARRAY TAXOLT(17) $ 1 TAXOLT1-TAXOLT17;
   ARRAY TAXNEW(17) $ 1 TAXNEW1-TAXNEW17;
   ARRAY TAXNET(17) $ 1 TAXNET1-TAXNET17;
   SET OVERDFT;
   ACTY='OD';
   IF SECCUST = '901' THEN PRICUST = 'Y';
   ELSE                    PRICUST = 'N';
   IF INPUT(OLDIC,$20.) IN ('0','.')   THEN OLDIC = ' ';
   IF OLDIC = NEWIC   THEN NEWIC = '  ';
   IF OLDIC NE ' '   THEN DO;
      OLDIC = UPCASE(OLDIC);
      CHECK = '0123456789AKP';
      X = VERIFY(OLDIC,CHECK);
      IF X GT 0  THEN DO;
         J = 0;
         DO I = 1 TO 17;
            TAXOLT(I) = ' ';
         END;
         DO I = 1 TO 17;
            TAXOLD(I) = SUBSTR(OLDIC,I,1);
            IF ('0' <= TAXOLD(I) <= '9')  OR
               ('A' <= TAXOLD(I) <= 'Z')
            THEN DO;
               J + 1;
               TAXOLT(J) = TAXOLD(I);
            END;
         END;
         OLDIC = TAXOLT(1)  || TAXOLT(2)  || TAXOLT(3)  ||
                 TAXOLT(4)  || TAXOLT(5)  || TAXOLT(6)  ||
                 TAXOLT(7)  || TAXOLT(8)  || TAXOLT(9)  ||
                 TAXOLT(10) || TAXOLT(11) || TAXOLT(12) ||
                 TAXOLT(13) || TAXOLT(14) || TAXOLT(15) ||
                 TAXOLT(16) || TAXOLT(17);
      END;
   END;
   IF NEWIC = '-N/A-               '        THEN NEWIC = ' ';
   ELSE IF NEWIC = 'N/A                 '   THEN NEWIC = ' ';
   ELSE IF INPUT(NEWIC,$17.) IN ('0','.')   THEN NEWIC = ' ';
   IF NEWIC NE ' ' THEN DO;
      NEWIC = UPCASE(NEWIC);
      CHECK = '0123456789';
      Y = VERIFY(NEWIC,CHECK);
      IF Y GT 0  THEN DO;
         J = 0;
         DO I = 1 TO 17;
            TAXNET(I) = ' ';
         END;
         DO I = 1 TO 17;
            TAXNEW(I) = SUBSTR(NEWIC,I,1);
            IF ('0' <= TAXNEW(I) <= '9')  OR
               ('A' <= TAXNEW(I) <= 'Z')
            THEN DO;
                  J + 1;
                  TAXNET(J) = TAXNEW(I);
            END;
         END;
         NEWIC = TAXNET(1)  || TAXNET(2)  || TAXNET(3)  ||
                 TAXNET(4)  || TAXNET(5)  || TAXNET(6)  ||
                 TAXNET(7)  || TAXNET(8)  || TAXNET(9)  ||
                 TAXNET(10) || TAXNET(11) || TAXNET(12) ||
                 TAXNET(13) || TAXNET(14) || TAXNET(15) ||
                 TAXNET(16) || TAXNET(17);
      END;
   END;

   /* REPLACE OLDIC WITH NEWIC IF OLDIC HAS TRUNCATED VALUE */
   IF OLDIC NE NEWIC THEN DO;
      IF SUBSTR(OLDIC,1,7)=SUBSTR(NEWIC,1,7)   OR
         SUBSTR(OLDIC,1,8)=SUBSTR(NEWIC,1,8)   OR
         SUBSTR(OLDIC,1,9)=SUBSTR(NEWIC,1,9)   OR
         SUBSTR(OLDIC,1,10)=SUBSTR(NEWIC,1,10)
         THEN OLDIC=' ';
   END;
   IF OLDIC = '  '    THEN DO;
      OLDIC = NEWIC;
      NEWIC = '  ';
   END;

   NEWIC = LEFT(NEWIC);

   IF INDORG = 'I' THEN DO;
      IF CACCCODE NOT IN ('001','002')  THEN OUTPUT INDOD;
   END; ELSE
   IF INDORG = 'O' THEN OUTPUT COROD;   ELSE
   IF CACCCODE IN ('000','004','020')   THEN OUTPUT COROD;
   ELSE;
RUN;
*;
PROC DATASETS LIB=WORK;
DELETE OVERDFT;
RUN;
*;
DATA ALLOD;
   SET INDOD COROD;
*;
   /** ESMR - 2009-161 MERGE WITH ELDS  **/
  /** ELDS END  **/

PROC FORMAT LIB=POSTCD CNTLOUT=STATEFMT; RUN;
PROC FORMAT CNTLIN=STATEFMT; RUN;

DATA INDCCRIS;
  FORMAT PROFESS $60.;
  SET INDLOAN INDOD;
  PROFESS = PUT(OCCUPAT,$PROF.);
  IF JOB NE ' ' THEN PROFESS = JOB;
  /* BASICGC = 11; */
  FICODE  = CACCCODE;
  IF LOANTYPE = .   THEN LOANTYPE = PRODUCT;
  APCODE  = LOANTYPE;
  NAMEKEY = '  ';
  DISTRICT = ' ';
  RESIDENT='R';
  IF CUSTCODE > 80   THEN RESIDENT='N';

  BUMI='9';
  IF CUSTCODE=77                THEN BUMI='1';
  IF CUSTCODE=78                THEN BUMI='2';
  IF BUMI='9' THEN DO;
     IF CUSTCDX=77              THEN BUMI='1';
     IF CUSTCDX=78              THEN BUMI='2';
  END;

  IF ACTY='OD'       THEN FOREIGN=STATE;
  /* IF CTRY = ' '      THEN COUNTRY = 'MY'; */

  IF PR_CTRY = 'MY' THEN NATIONAL = PR_CTRY;
  ELSE                   NATIONAL = CITIZEN;
  /*
  IF CUSTCODE LT 80  THEN DO;
     NATIONAL = 'MY';
     COUNTRY  = 'MY';
  END;
  */

  /* PHONE3   = ' '; */
  PHONE4   = ' ';
  /*
  IF MAILSTAT NOT IN ('01','02','03','04','05','06','07','08',
                      '09','10','11','12','13','14','15','16')
                       THEN MAILSTAT = '00';
  */

  IF MAILCODE = '' THEN MAILCODE = '-0000';
  MAILSTAT = PUT(MAILCODE,$STATECD.);
  IF MAILSTAT = '' THEN MAILSTAT = '-1';
  IF MAILCODE = '00000' THEN MAILSTAT = '00';

  IF GENDER = 'M'      THEN GENDER = 'L';    ELSE
  IF GENDER = 'F'      THEN GENDER = 'P';    ELSE
     GENDER = 'R';
  IF MARITAL IN ('M','P','W')   THEN MARITAL = 'M';    ELSE
  IF MARITAL IN ('S','D')       THEN MARITAL = 'S';    ELSE
     MARITAL = 'U';

  IF SPOUSE1I NE ' '  THEN DO;
     SPOUSE1I = COMPRESS(SPOUSE1I,'=`&-/@#*+:().,"%�!$?_ ');
     SPOUSE1I = COMPRESS(SPOUSE1I,"'");
  END;
  IF SPOUSE1D NE ' '  THEN DO;
     SPOUSE1D = COMPRESS(SPOUSE1D,'=`&-/@#*+:().,"%�!$?_ ');
     SPOUSE1D = COMPRESS(SPOUSE1D,"'");
  END;
  IF SPOUSE1I = ' ' AND SPOUSE1D = ' '  THEN SPOUSE1 = ' ';
  CUSTNAME = COMPRESS(CUSTNAME,'\');
  /*
  IF BGC EQ ''
     THEN BGC=BASICGC;
  */
  IF ANNSUBTSALARY IN (.,0) THEN ANNSUBTSALARY = 0.00;

  IF APCODE IN (800:899) AND
     2000000000<=ACCTNO<=2999999999 THEN BRANCH=904;

  IF APCODE IN (800:899) AND
     8000000000<=ACCTNO<=8999999999 THEN BRANCH=904;

  IF UNDISBURSE IN ('Y') AND BRANCH IN (902) THEN BRANCH=904;

  IF MASCO_CD NE '' THEN OCCUPAT_MASCO_CD = MASCO_CD;
  FILE OUTPUT1;
     PUT @0001 FICODE     Z3.
         @0007 BRANCH     Z3.
         @0010 APCODE     Z3.
         @0013 CUSTNO     20.
         @0033 ACCTNO     10.
         @0043 NAMEKEY  $140.
         @0183 CUSTNAME $150.
         @0333 NEWIC     $20.
         @0353 OLDIC     $20.
         @0373 DOBDD       2.
         @0375 DOBMM       2.
         @0377 DOBCC       2.
         @0379 DOBYY       2.
         @0381 GENDER     $1.
         @0382 NATIONAL   $2.
      /* @0384 MARITAL    $1. */
      /* @0385 BUMI       $1. */
         @0387 BGC        $2.
         @0389 LSTMNTDD    2.
         @0391 LSTMNTMM    2.
         @0393 LSTMNTCC    2.
         @0395 LSTMNTYY    2.
         @0397 ADDRLN1   $40.
         @0437 ADDRLN2   $40.
         @0477 ADDRLN3   $40.
         @0517 ADDRLN4   $40.
      /* @0557 LSTCHGDD    2. */
      /* @0559 LSTCHGMM    2. */
      /* @0561 LSTCHGCC    2. */
      /* @0563 LSTCHGYY    2. */
         @0565 COUNTRY    $2.
         @0567 MAILCODE    5.
         @0572 DISTRICT  $20.
         @0592 MAILSTAT  $20.
         @0612 PRIPHONE  $20.
         @0632 SECPHONE  $20.
         @0652 MOBIPHON  $20.
         @0672 PHONE4    $20.
         @0692 SPOUSE1  $150.
         @0842 SPOUSE1I  $20.
         @0862 SPOUSE1D  $20.
         @1452 EMPLOYER_NAME $150.
         @1602 PROFESS   $60.
         @1662 EMPLDD      2.
         @1664 EMPLMM      2.
         @1666 EMPLCC      2.
         @1668 EMPLYY      2.
         @1670 RESIDENT   $1.
         @1671 COSTCTR     4.
         @1675 EMPNATUR    $10.
         @1685 EMPLOCAT    $200.
         @1885 BNMSECT     $6.
         @1891 LONGNAME    $150.
      /* @2041 ANNSUBTSALARY 16.2 */
         @2058 SIC_ISS       $5.
         @2063 PRICUST       $1.
         @2064 OCCUPAT_MASCO_CD $5.
         @2069 EMPLOY_SECTOR_CD $5.
         @2074 EMPLOY_TYPE_CD   $3.
         @2077 CUSTID      $100.
         @2177 BNM_ASSIGN_ID   $20.
         @2197 CUST_CODE        $5.
         @2202 RESTATUS         $3.
         ;
*;
PROC DATASETS LIB=WORK;
DELETE INDOD INDLOAN INDCCRIS;
RUN;
*;
   /** ESMR - 2009-161 MERGE WITH ELDS  **/
DATA CORCCRIS;
  SET CORLOAN COROD;
  FICODE  = CACCCODE;
  IF LOANTYPE = .   THEN LOANTYPE = PRODUCT;
  APCODE  = LOANTYPE;
  NAMEKEY = '  ';
  DISTRICT = ' ';
  /* PHONE3   = ' '; */
  PHONE4   = ' ';
  /* REGCOUTY = 'MY'; */
  BUMI=' ';
  IF CUSTCODE IN (41,42,43,61,66)   THEN BUMI='1';
  IF CUSTCODE IN (44,46,47,62,67)   THEN BUMI='2';
  IF CUSTCODE IN (52,53,54,57,59,64,69,70,71,72,73,74,75)
                                    THEN BUMI='3';
  IF CUSTCODE IN (1,35,48,49,51,63,68,79,81,82,83,84,85,86,
                  90,91,92,98,99)   THEN BUMI='9';
  IF CUSTCODE IN (2,3,4,5,6,11,12,13,17,30,31,
                  32,33,34,36,37,38,39,40,45) THEN DO;
     BUMI='9';
     IF ACTY='LN' THEN DO;
        IF USER1='3'           THEN BUMI='1';
        IF USER1='4'           THEN BUMI='2';
     END;
     IF ACTY='OD' THEN DO;
        IF ORGTYPE='3'         THEN BUMI = '1';
        IF ORGTYPE='4'         THEN BUMI = '2';
     END;
  END;
  RESIDENT='R';
  IF CUSTCODE > 80 THEN RESIDENT='N';
  /* IF CTRY = ' '    THEN COUNTRY = 'MY'; */

  /*
  IF CUSTCODE LT 80  THEN COUNTRY = 'MY';
  */
  /*
  IF MAILSTAT NOT IN ('01','02','03','04','05','06','07','08',
                      '09','10','11','12','13','14','15','16')
                       THEN MAILSTAT = '00';
  */

  IF MAILCODE = '' THEN MAILCODE = '-0000';
  MAILSTAT = PUT(MAILCODE,$STATECD.);
  IF MAILSTAT = '' THEN MAILSTAT = '-1';
  IF MAILCODE = '00000' THEN MAILSTAT = '00';

  BASICGC=91;
  IF CUSTCODE IN (99)           THEN BASICGC = 91;    ELSE
  IF CUSTCODE IN (98)           THEN BASICGC = 51;    ELSE
  IF CUSTCODE IN (79)           THEN BASICGC = 43;    ELSE
  IF CUSTCODE IN (35)           THEN BASICGC = 42;    ELSE
  IF CUSTCODE IN (01,74)        THEN BASICGC = 34;    ELSE
  IF CUSTCODE IN (73)           THEN BASICGC = 33;    ELSE
  IF CUSTCODE IN (72)           THEN BASICGC = 32;    ELSE
  IF CUSTCODE IN (71,90,91,92)  THEN BASICGC = 31;

  IF ACTY='LN' THEN DO;
     IF CUSTCODE IN (79,98,99)             AND ORGTYPE='T'
        THEN BASICGC = 41;
     IF CUSTCODE IN (40,41,42,43,44,46,47,48,49,51,52,53,54,68,
                  61,62,66,67,86)          AND ORGTYPE='I'
        THEN BASICGC=21; ELSE
     IF CUSTCODE IN (40,41,42,43,44,46,47,48,49,51,52,53,54,68,
                  61,62,66,67,86)          AND ORGTYPE='P'
        THEN BASICGC=22; ELSE
     IF CUSTCODE IN (40,41,42,43,44,46,47,48,49,51,52,53,54,68,
                  61,62,66,67,86)          AND ORGTYPE='L'
        THEN BASICGC=23; ELSE
     IF CUSTCODE IN (2,3,4,5,6,11,12,13,17,20,30,31,32,33,34,37,38,39,
                   40,41,42,43,44,46,47,48,49,51,52,53,54,61,62,66,67,
                   68,57,59,63,64,69,75,82,83,84) AND ORGTYPE='C'
        THEN BASICGC=24;
  END;
  ELSE DO;
  IF ACTY='OD' THEN DO;
     IF SPOUSE1 EQ ' ';
     IF CUSTCODE IN (79,98,99)             AND PURPOSE='J'
        THEN BASICGC = 41;
     IF CUSTCODE IN (40,41,42,43,44,46,47,48,49,51,52,53,54,68,
                     61,62,66,67,86)       AND PURPOSE='7'
        THEN BASICGC=21;                   ELSE
     IF CUSTCODE IN (40,41,42,43,44,46,47,48,49,51,52,53,54,68,
                     61,62,66,67,86)       AND PURPOSE='8'
        THEN BASICGC=22;                   ELSE
     IF CUSTCODE IN (40,41,42,43,44,46,47,48,49,51,52,53,54,68,
                     61,62,66,67,86)       AND PURPOSE='I'
        THEN BASICGC=23;                   ELSE
     IF CUSTCODE IN (2,3,4,5,6,11,12,13,17,20,30,31,32,33,34,37,38,
                39,40,41,42,43,44,46,47,48,49,51,52,53,54,61,62,66,
                67,68,57,59,63,64,69,75,82,83,84)
                  AND PURPOSE IN ('9','A','E')
        THEN BASICGC=24;
  END;
  END;
  IF CACCCODE IN ('017','012')                 THEN BASICGC=24;
  IF BASICGC IN (31,32,33,34,41,42,43,51,91)   THEN BUMI='9';

  NRCC=9;
  IF CITIZEN='MY' AND BASICGC=24 AND CUSTCODE NOT IN (48,49,51,63,68)
     THEN NRCC=1;
  ELSE IF             BASICGC=24 AND CUSTCODE IN     (48,49,51,63,68)
     THEN NRCC=2;

  IF BASICGC IN (23,41,42,43,51,91)    THEN DO;
     IF BUSSREG = ' '  THEN BUSSREG = NEWIC;
     IF NEWIC = ' '    THEN BUSSREG = OLDIC;
  END;
  IF BUSSREG = ' '  THEN BUSSREG = NEWIC;
  IF BUSSREG = ' '  THEN BUSSREG = OLDIC;
  IF BUSSREG = ' '  AND NOCUSTOM EQ 1  THEN BUSSREG = GUAREND;
  /*
  IF ORGTYPE = 'C'  AND BUSSREG NE ' ' OR BASICGC = 24  THEN DO;
     TRIMLEN = LENGTH(TRIM(BUSSREG));
     IF TRIMLEN <= 7   THEN DO;
        VLEFT  = SUBSTR(TRIM(BUSSREG),1,TRIMLEN-1);
        VRIGHT = SUBSTR(TRIM(BUSSREG),TRIMLEN,1);
        VNUMIC = INPUT(VLEFT,6.);
        IF VNUMIC =.  THEN VNEWA = VLEFT;
        ELSE VNEWA = PUT(VNUMIC,Z6.);
        BUSSREG = TRIM(VNEWA) || TRIM(VRIGHT);
     END;
  END;  ELSE
  IF ORGTYPE IN ('I','P')  AND  BUSSREG NE ' '  AND
     BASICGC IN (21,22,23) THEN DO;
     TRIMLEN = LENGTH(TRIM(BUSSREG));
     IF TRIMLEN <= 10   THEN DO;
        VLEFT  = SUBSTR(TRIM(BUSSREG),1,TRIMLEN-1);
        VRIGHT = SUBSTR(TRIM(BUSSREG),TRIMLEN,1);
        VNUMIC = INPUT(VLEFT,9.);
        IF VNUMIC =.  THEN VNEWA = VLEFT;
        ELSE VNEWA = PUT(VNUMIC,Z9.);
        BUSSREG = TRIM(VNEWA) || TRIM(VRIGHT);
     END;
  END;
  */
  CUSTNAME = COMPRESS(CUSTNAME,'\');
  IF BGC EQ ''
     THEN BGC=BASICGC;
RUN;
PROC SORT DATA=ELDS NODUPKEYS; BY ICPP;
PROC SORT DATA=CORCCRIS; BY BUSSREG;
DATA CORCCRIS;
   MERGE ELDS(IN=A RENAME=ICPP=BUSSREG) CORCCRIS(IN=B DROP=BNMSECT);
   BY BUSSREG;
   IF B;
   IF MNISECT NOT IN ('1300','3110','3115','3113','3114','3219','3242',
                      '3250','3311','3313','3432','3551','3619','3852',
                      '3919','6110','6120','6130') THEN BNMSECT=MNISECT;
RUN;
DATA CORCCRIS;
  SET CORCCRIS;

  IF APCODE IN (800:899) AND
     2000000000<=ACCTNO<=2999999999 THEN BRANCH=904;

  IF APCODE IN (800:899) AND
     8000000000<=ACCTNO<=8999999999 THEN BRANCH=904;

  IF UNDISBURSE IN ('Y') AND BRANCH IN (902) THEN BRANCH=904;

  IF SIC_ISS NE '' THEN INDUSTRIAL_SECTOR_CD = SIC_ISS;
  FILE OUTPUT2;
     PUT @0001 FICODE     Z3.
         @0007 BRANCH     Z3.
         @0010 APCODE     Z3.
         @0013 CUSTNO     20.
         @0033 ACCTNO     10.
         @0043 NAMEKEY  $140.
         @0183 CUSTNAME $150.
         @0333 BUSSREG   $20.
         @0353 DOBDD       2.
         @0355 DOBMM       2.
         @0357 DOBCC       2.
         @0359 DOBYY       2.
         @0361 CITIZEN    $2.
      /* @0363 BUMI       $1. */
      /* @0364 NRCC        1. */
         @0366 BGC        $2.
         @0368 LSTMNTDD    2.
         @0370 LSTMNTMM    2.
         @0372 LSTMNTCC    2.
         @0374 LSTMNTYY    2.
         @0376 ADDRLN1   $40.
         @0416 ADDRLN2   $40.
         @0456 ADDRLN3   $40.
         @0496 ADDRLN4   $40.
      /* @0536 LSTCHGDD    2. */
      /* @0538 LSTCHGMM    2. */
      /* @0540 LSTCHGCC    2. */
      /* @0542 LSTCHGYY    2. */
         @0544 COUNTRY    $2.
         @0546 MAILCODE    5.
         @0551 DISTRICT  $20.
         @0571 MAILSTAT  $20.
         @0591 PRIPHONE  $20.
         @0611 SECPHONE  $20.
         @0631 MOBIPHON  $20.
         @0651 PHONE4    $20.
         @0671 RESIDENT   $1.
         @0672 COSTCTR     4.
         @0676 EMPNATUR    $10.
         @0686 BNMSECT     $6.
         @0692 LONGNAME    $150.
         @0843 SIC_ISS     $5.
         @0848 PRICUST     $1.
         @0945 INDUSTRIAL_SECTOR_CD $5.
         @0950 CUSTID    $100.
         @1050 BNM_ASSIGN_ID   $20.
         @1070 NEW_BUSS_REG_ID $20.
         @1090 CUST_CODE   $5.
         @1095 RESTATUS    $3.
         @1098 CORPSTATUS  $3.
         @1101 SECTOR_CODE $5.
         @1106 NOEMPLO     8.
         @1114 TURNOVER    20.
         ;
*;
PROC DATASETS LIB=WORK;
DELETE CORCCRIS;
RUN;
*;
DATA CCRISOWN;
  SET ALLLOAN ALLOD;
*;
DATA OWNER;
  SET CISDP.OWNER
      CISLN.OWNER;
*;
PROC SORT DATA=OWNER; BY CUSTNO;
PROC SORT DATA=CCRISOWN; BY CUSTNO;

DATA CORPOWN(DROP=CUSTNO RENAME=(OWNER=CUSTNO));
 MERGE CCRISOWN(IN=A)
       OWNER(IN=B);
 BY CUSTNO;
 IF A AND B;
 IF ((RELATCD1='049' AND RELATCD2='049') OR
      BGC IN ('21'',22','23') OR
     (RELATCD1='050' AND RELATCD2='050')) AND
    INDORG='O' THEN OUTPUT;
*;
PROC SORT DATA=CORPOWN NODUP; BY CUSTNO;
PROC SORT DATA=CORPOWN OUT=BRCHFIX(KEEP=ACCTNO BRANCH OWNERDD OWNERMM
                                        OWNERCC OWNERYY) NODUPKEYS;
   BY ACCTNO;
RUN;
PROC SORT DATA=CORPOWN;
   BY ACCTNO;
RUN;
DATA CORPOWN;
   MERGE BRCHFIX (IN=B) CORPOWN (IN=A DROP=BRANCH OWNERDD OWNERMM
                                           OWNERCC OWNERYY);
   BY ACCTNO;
   IF A;
RUN;
PROC SORT DATA=CORPOWN
   (KEEP=CUSTNO OWNERNAM OWNERID1 OWNERID2 ACCTNO COSTCTR BRANCH
         RELATCD1 RELATCD2 ACCTNO LOANTYPE PRODUCT CUSTNAME
         OWNERDD OWNERMM OWNERCC OWNERYY UNDISBURSE LONGNAME)
   NODUPKEYS;
   BY ACCTNO CUSTNO OWNERNAM OWNERID1 OWNERID2;
*;
PROC SORT; BY BRANCH ACCTNO;
*;
DATA CCRISOWN;
  SET CORPOWN;
  FICODI=' ';
  IF LOANTYPE=.  THEN LOANTYPE = PRODUCT;
  APCODE   = LOANTYPE;
  NAMEKEY  = '  ';
  CUSTNAME = COMPRESS(CUSTNAME,'\');
  OWNER = CUSTNO;
  IF OLDIC = ' '   THEN DO;
     OLDIC = NEWIC;
     NEWIC = '  ';
  END;

  IF UNDISBURSE IN ('Y') AND BRANCH IN (902) THEN BRANCH=904;

  FILE OUTPUT3;
     PUT @0001 FICODI     $6.
         @0007 BRANCH     Z3.
         @0010 APCODE      3.
         @0013 OWNER      20.
         @0033 ACCTNO     10.
         @0043 NAMEKEY  $140.
         @0183 CUSTNAME $150.
         @0333 OLDIC     $20.
         @0353 OWNERNAM $150.
         @0503 OWNERID1  $20.
         @0523 OWNERID2  $20.
         @0543 OWNERDD    $2.
         @0545 OWNERMM    $2.
         @0547 OWNERCC    $2.
         @0549 OWNERYY    $2.
         @0551 COSTCTR     4.
         @0555 LONGNAME $150.
         @0706 SIC_ISS    $5.
         ;
*;
PROC CONTENTS DATA=WORK._ALL_ NODS;
*;

//EIIMPBMC JOB MSGCLASS=X,MSGLEVEL=(1,1),REGION=8M
/*JOBPARM S=S1M2
//**********************************************************
//* ESMR 2016-572                                          *
//* ESMR DESC: REPORTING FORMAT SIMILAR TO EIBMPBMC        *
//**********************************************************
//DELETE  EXEC PGM=IEFBR14
//DEL01    DD DSN=SAP.PIBB.PBMICRO.RPT,
//            DISP=(MOD,DELETE,DELETE),
//            SPACE=(CYL,(0))
//*
//EIIMPBMC EXEC SAS609
//SAS      DD DSN=SAP.PIBB.SASDATA,DISP=SHR
//LOAN     DD DSN=SAP.PIBB.MNILN(0),DISP=SHR
//DISPAY   DD DSN=SAP.PIBB.DISPAY,DISP=SHR
//PRVLN    DD DSN=SAP.PIBB.MNILN(-4),DISP=SHR
//CCRIS    DD DSN=SAP.PBB.CCRIS.CREDSUB,DISP=SHR
//PGM      DD DSN=SAP.BNM.PROGRAM,DISP=SHR
//SASLIST  DD DSN=SAP.PIBB.PBMICRO.RPT,
//            DISP=(NEW,CATLG,DELETE),
//            SPACE=(TRK,(10,10),RLSE),
//            UNIT=(SYSDA,3),
//            DCB=(LRECL=256,RECFM=FBA,BLKSIZE=0,BUFNO=30)
//SYSIN    DD *

OPTIONS YEARCUTOFF=1950 NOCENTER NODATE NONUMBER MISSING=0;

DATA _NULL_;
   SET LOAN.REPTDATE;
   MM1 = MONTH(REPTDATE)-1;
   IF MM1 = 0 THEN MM1 = 12;
   CALL SYMPUT('NOWK',PUT('4',$1.));
   CALL SYMPUT('REPTYEAR',PUT(REPTDATE,YEAR2.));
   CALL SYMPUT('REPTMON',PUT(MONTH(REPTDATE),Z2.));
   CALL SYMPUT('PREVMON',PUT(MM1,Z2.));
   CALL SYMPUT('RDATE', PUT(REPTDATE, DDMMYY8.));
RUN;

DATA LOAN&REPTMON&NOWK;
   MERGE SAS.LOAN&PREVMON&NOWK SAS.LOAN&REPTMON&NOWK;
   BY ACCTNO NOTENO;
   WHERE PRODCD NOT IN ('34180','34240');
   IF  PRODUCT = 428 AND CENSUS IN (428.00,428.01,428.02,428.03) OR
   PRODUCT = 439;
RUN;

DATA DISPAY;
   SET DISPAY.IDISPAYMTH&REPTMON;
   WHERE DISBURSE > 0 OR REPAID > 0;
RUN;
PROC SORT DATA=DISPAY; BY ACCTNO NOTENO;

DATA DISPAY;
   MERGE LOAN&REPTMON&NOWK(IN=A) DISPAY(IN=B);
   BY ACCTNO NOTENO;
   IF A & B;
RUN;
PROC SORT DATA=DISPAY (KEEP=ACCTNO NOTENO FISSPURP PRODUCT
      PRODCD CUSTCD AMTIND SECTORCD DISBURSE REPAID BRANCH ACCTYPE);
   BY ACCTNO NOTENO CUSTCD FISSPURP SECTORCD;
RUN;
 *** CURRENT MTH ***;
DATA CURMTH;
   SET SAS.LOAN&REPTMON&NOWK(DROP=BALANCE RENAME=(BAL_AFT_EIR=BALANCE));
   IF  PAIDIND NOT IN ('P','C')  OR EIR_ADJ NE .;
   IF  PRODUCT = 428 AND CENSUS IN (428.00,428.01,428.02,428.03) OR
   PRODUCT = 439;
   IF  BALANCE NOT IN (.,0) THEN NOACC=1;

RUN;
PROC SORT DATA=CURMTH; BY ACCTNO NOTENO;
DATA LOAN;
   MERGE CURMTH(IN=A) DISPAY(IN=B);
   BY ACCTNO NOTENO;
RUN;
*;
PROC SUMMARY DATA=LOAN NWAY;
   VAR BALANCE NOACC DISBURSE REPAID;
   OUTPUT OUT=LN1 (DROP=_FREQ_ _TYPE_) SUM=;
RUN;

PROC PRINT DATA=LN1 SPLIT='*';
   VAR BALANCE NOACC DISBURSE REPAID;
   SUM BALANCE NOACC DISBURSE REPAID;
   LABEL BALANCE='O/S BALANCE'
         NOACC='NO OF*ACCOUNT'
         DISBURSE='DISBURSEMENT*AMOUNT'
         REPAID='REPAYMENT*AMOUNT';
   FORMAT BALANCE DISBURSE REPAID COMMA15.2
          NOACC COMMA10.;
   TITLE  'PUBLIC ISLAMIC BANK BERHAD';
   TITLE1 'PERFORMANCE REPORT ON PB MICRO FINANCE AS AT ' "&RDATE";
   TITLE2 'REPORT ID : EIIMPBMC';
RUN;

PROC SORT DATA=CURMTH; BY ACCTNO NOTENO BRANCH; RUN;
PROC SORT DATA=CCRIS.CREDMSUBAC&REPTMON&REPTYEAR
           OUT=CREDMSUB(KEEP=ACCTNUM NOTENO BRANCH DAYSARR MTHARR
                        RENAME=(ACCTNUM=ACCTNO DAYSARR=DAYARR));
   BY ACCTNUM NOTENO BRANCH;
RUN;

DATA LN2;
   MERGE CURMTH(IN=A) CREDMSUB;
   BY ACCTNO NOTENO BRANCH;
   IF A;
   IF LOANSTAT = 3 AND BALANCE NE 0;
RUN;

PROC PRINT DATA=LN2 SPLIT='*';
   VAR ACCTNO NOTENO LOANSTAT BALANCE DAYARR MTHARR;
   SUM BALANCE;
   LABEL ACCTNO='ACCOUNT*NO'
         NOTENO='NOTE*NO'
         LOANSTAT='LOAN*STATUS'
         BALANCE='O/S BALANCE'
         DAYARR='DAYS IN*ARREARS'
         MTHARR='MTHS IN*ARREARS';
   FORMAT BALANCE COMMA15.2;
   TITLE  'PUBLIC ISLAMIC BANK BERHAD';
   TITLE1 'PB MICRO A/C WITH LOAN STATUS 3 4 AS AT ' "&RDATE";
   TITLE2 'REPORT ID : EIIMPBMC';
RUN;

//

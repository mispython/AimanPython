//EIIHLNGR JOB MSGCLASS=X,MSGLEVEL=(1,1),REGION=64M,NOTIFY=&SYSUID
//*
//DELETE    EXEC PGM=IEFBR14
//DD1       DD DSN=SAP.PIBB.LNGUAR.BANKINST,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,
//            SPACE=(CYL,1,RLSE)
//DD2       DD DSN=SAP.PIBB.LNGUAR.XBNKINST,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,
//            SPACE=(CYL,1,RLSE)
//DD3       DD DSN=SAP.PIBB.LNGUAR.CUSTLIST,
//            DISP=(MOD,DELETE,DELETE),UNIT=SYSDA,
//            SPACE=(CYL,1,RLSE)
//EIIHLNGR  EXEC SAS609
//LOAN      DD DSN=SAP.PIBB.SASDATA,DISP=SHR
//COLL      DD DSN=SAP.PIBB.MNICOL(0),DISP=SHR
//LNGRFBI   DD DSN=SAP.PIBB.LNGUAR.BANKINST,
//             DISP=(NEW,CATLG,DELETE),
//             DCB=(RECFM=FB,LRECL=256,BLKSIZE=28160),
//             SPACE=(CYL,(5,2)),UNIT=SYSDA
//LNNGRFBI  DD DSN=SAP.PIBB.LNGUAR.XBNKINST,
//             DISP=(NEW,CATLG,DELETE),
//             DCB=(RECFM=FB,LRECL=256,BLKSIZE=28160),
//             SPACE=(CYL,(5,2)),UNIT=SYSDA
//CUSTLIST  DD DSN=SAP.PIBB.LNGUAR.CUSTLIST,
//             DISP=(NEW,CATLG,DELETE),
//             DCB=(RECFM=FB,LRECL=256,BLKSIZE=28160),
//             SPACE=(CYL,(5,2)),UNIT=SYSDA
//SORTWK01  DD UNIT=SYSDA,SPACE=(CYL,(500))
//SORTWK02  DD UNIT=SYSDA,SPACE=(CYL,(500))
//SORTWK03  DD UNIT=SYSDA,SPACE=(CYL,(500))
//SYSIN     DD *
OPTIONS NOCENTER MISSING=0;

DATA REPTDATE;
  SET LOAN.REPTDATE;
  PREVHALF = INTNX('MONTH',REPTDATE,-6,'E');
  CALL SYMPUT('REPTMON',PUT(MONTH(REPTDATE),Z2.));
  CALL SYMPUT('REPTYEAR',PUT(REPTDATE,YEAR2.));
  CALL SYMPUT('RDATE',PUT(REPTDATE,DATE9.));
  FORMAT REPTDATE PREVHALF DATE9.;
RUN;

PROC FORMAT;
 VALUE $CUSTDESC
 '80'='NON-RESIDENTS/FOREIGN ENTITIES'
 '81'='FOREIGN BANKING INSTITUTIONS'
 '82'='AFFILIATES ABROAD'
 '83'='G7 COUNTRIES'
 '84'='FOREIGN BANK IN OTHER COUNTRIES'
 '85'='FOREIGN NON-BANK ENTITIES'
 '86'='FOREIGN BUSINESS ENTERPRISES'
 '87'='MICRO'
 '88'='SMALL'
 '89'='MEDIUM'
 '90'='FOREIGN GOVERNMENTS'
 '91'='FOREIGN CENTRAL BANKS'
 '92'='FOREIGN DIPLOMATIC REPRESENTATION IN MALAYSIA'
 '95'='FOREIGN INDIVIDUALS'
 '96'='FOREIGN EMPLOYED/STUDIED IN MALAYSIA'
 '98'='FOREIGN NON COMMERCIAL INTERNATIONAL ORGANISATION IN MALAYSIA'
 '99'='FOREIGN OTHER ENTITIES NIE'
  ;
RUN;

DATA LN;
  SET LOAN.LOAN&REPTMON.4;
  WHERE (PAIDIND NOT IN ('P','C') OR EIR_ADJ ^= .) AND
        INPUT(CUSTCD,8.) >= 80;
  KEEP ACCTNO NOTENO PRODUCT CUSTCD PAIDIND EIR_ADJ BAL_AFT_EIR;
RUN;

DATA CFINGUAR;
  SET COLL.COLLATER;
  WHERE CDOLARV > 0 AND
  CGUARNAT IN ('01','02','03','04','05','06','07');
  GUARANTEE_IND = 'Y';
  KEEP ACCTNO NOTENO CCOLLNO CDOLARV CGUARNAT GUARANTEE_IND;
RUN;

PROC SQL;
CREATE TABLE LN_GUAR AS
SELECT T1.*,
       T2.CCOLLNO,
       T2.CGUARNAT,
       T2.GUARANTEE_IND
       FROM LN T1 LEFT JOIN CFINGUAR T2 ON T1.ACCTNO=T2.ACCTNO AND
       T1.NOTENO=T2.NOTENO;
QUIT;

PROC SQL;
CREATE TABLE LN_OSBAL AS
SELECT DISTINCT ACCTNO,
                NOTENO,
                PRODUCT,
                CUSTCD,
                PAIDIND,
                BAL_AFT_EIR,
                CCOLLNO,
                CGUARNAT,
                CASE WHEN GUARANTEE_IND ^= 'Y' THEN 'N'
                ELSE 'Y' END AS GUARANTEE_IND
FROM LN_GUAR;
QUIT;

PROC SUMMARY DATA=LN_OSBAL NWAY;
  CLASS CUSTCD GUARANTEE_IND;
  VAR BAL_AFT_EIR;
  OUTPUT OUT=OSBAL_CUSTGUAR SUM=;
RUN;

DATA FOREIGN_BKINST NON_FOREIGN_BKINST;
  SET OSBAL_CUSTGUAR;
  IF GUARANTEE_IND = 'Y' THEN BAL_GUAR = BAL_AFT_EIR;
  ELSE BAL_NON_GUAR = BAL_AFT_EIR;

  IF INPUT(CUSTCD,8.) < 85 THEN DO;
     OUTPUT FOREIGN_BKINST;
     CUSTCD = '81';
     OUTPUT FOREIGN_BKINST;
  END;
  ELSE DO;
     OUTPUT NON_FOREIGN_BKINST;
     CUSTCD = '85';
     OUTPUT NON_FOREIGN_BKINST;
  END;
RUN;

DATA CUST_OSBAL;
  SET LN_OSBAL;
  CUSTTYPE = PUT(CUSTCD,$CUSTDESC.);
RUN;

DATA FOREIGN_BKINST;
  SET FOREIGN_BKINST;
  CUSTTYPE = PUT(CUSTCD,$CUSTDESC.);
RUN;

DATA NON_FOREIGN_BKINST;
  SET NON_FOREIGN_BKINST;
  CUSTTYPE = PUT(CUSTCD,$CUSTDESC.);
RUN;

PROC SUMMARY DATA=FOREIGN_BKINST NWAY;
  CLASS CUSTCD CUSTTYPE;
  VAR BAL_GUAR BAL_NON_GUAR BAL_AFT_EIR;
  OUTPUT OUT=FOREIGN_BKINST_SUM SUM=;
RUN;

PROC SUMMARY DATA=NON_FOREIGN_BKINST NWAY;
  CLASS CUSTCD CUSTTYPE;
  VAR BAL_GUAR BAL_NON_GUAR BAL_AFT_EIR;
  OUTPUT OUT=NON_FOREIGN_BKINST_SUM SUM=;
RUN;

PROC PRINTTO FILE=LNGRFBI;
PROC REPORT DATA=FOREIGN_BKINST_SUM SPLIT='*';
  TITLE1 'PUBLIC ISLAMIC BANK BERHAD';
  TITLE2 "LOAN EXTENDED TO NON-RESIDENT/FOREIGN ENTITIES ACCORDING TO"
         " GUARANTEE OR NON GUARANTEE @ &REPTMMMYY";
  COLUMN CUSTCD CUSTTYPE BAL_GUAR BAL_NON_GUAR BAL_AFT_EIR;
  DEFINE CUSTCD / 'CODE' FORMAT=$4.;
  DEFINE CUSTTYPE / 'TYPE';
  DEFINE BAL_GUAR / 'GUARANTEE O/S BALANCE' FORMAT=18.2;
  DEFINE BAL_NON_GUAR / 'NON GUARANTEE O/S BALANCE' FORMAT=18.2;
  DEFINE BAL_AFT_EIR / 'TOTAL OUTSTANDING' FORMAT=18.2;
RUN;

PROC PRINTTO FILE=LNNGRFBI;
PROC REPORT DATA=NON_FOREIGN_BKINST_SUM SPLIT='*';
  TITLE1 'PUBLIC ISLAMIC BANK BERHAD';
  TITLE2 "LOAN EXTENDED TO NON-RESIDENT/FOREIGN ENTITIES ACCORDING TO"
         " GUARANTEE OR NON GUARANTEE @ &REPTMMMYY";
  COLUMN CUSTCD CUSTTYPE BAL_GUAR BAL_NON_GUAR BAL_AFT_EIR;
  DEFINE CUSTCD / 'CODE' FORMAT=$4.;
  DEFINE CUSTTYPE / 'TYPE';
  DEFINE BAL_GUAR / 'GUARANTEE O/S BALANCE' FORMAT=18.2;
  DEFINE BAL_NON_GUAR / 'NON GUARANTEE O/S BALANCE' FORMAT=18.2;
  DEFINE BAL_AFT_EIR / 'TOTAL OUTSTANDING' FORMAT=18.2;
RUN;

PROC PRINTTO FILE=CUSTLIST;
PROC REPORT DATA=CUST_OSBAL SPLIT='*';
  TITLE1 'PUBLIC ISLAMIC BANK BERHAD';
  TITLE2 "LOAN EXTENDED TO NON-RESIDENT/FOREIGN ENTITIES ACCORDING TO"
         " GUARANTEE OR NON GUARANTEE @ &REPTMMMYY";
  COLUMN ACCTNO NOTENO PRODUCT BAL_AFT_EIR
         CUSTCD PAIDIND CCOLLNO CGUARNAT GUARANTEE_IND;
  DEFINE ACCTNO / 'ACCTNO';
  DEFINE NOTENO / 'NOTENO';
  DEFINE PRODUCT / 'PRODUCT';
  DEFINE BAL_AFT_EIR / 'BAL_AFT_EIR' FORMAT=18.2;
  DEFINE CUSTCD / 'CUSTFISS' FORMAT=$4.;
  DEFINE PAIDIND / 'PAIDIND';
  DEFINE CCOLLNO / 'CCOLLNO';
  DEFINE CGUARNAT / 'CGUARNAT';
  DEFINE GUARANTEE_IND / 'GUARANTEE_IND';
RUN;

//*----------------------------------------------------------------
//* FTP TO SAS DATAWAREHOUSE
//*----------------------------------------------------------------
//*%OPC SCAN
//RUNSFTP  EXEC COZBATCH
//CMD.SYSUT1 DD DISP=SHR,DSN=OPER.PBB.PARMLIB(DRR#SFTP)
//           DD *
lzopts servercp=$servercp,notrim,overflow=trunc,mode=text
lzopts linerule=$lr
cd "FD-GFTA\DSIB TA3"
PUT //SAP.PIBB.LNGUAR.BANKINST IBANKINST@%ODD.%OMM.%OYY..TXT
PUT //SAP.PIBB.LNGUAR.XBNKINST IXBNKINST@%ODD.%OMM.%OYY..TXT
PUT //SAP.PIBB.LNGUAR.CUSTLIST ICUST_BANKINST@%ODD.%OMM.%OYY..TXT
EOB
/*

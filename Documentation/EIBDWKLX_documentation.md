# EIBDWKLX - Loan Data Processing with Date Validation

## Overview

This Python script converts the JCL/SAS program **EIBDWKLX** that performs conditional loan data processing with strict date validation.

## Program Details

- **Program**: EIBDWKLX
- **ESMR**: 06-1428
- **Dependencies**: Run after EIBDLNEX
- **Purpose**: Validate loan extraction date and conditionally execute processing

## Requirements

```bash
pip install duckdb polars pyarrow --break-system-packages
```

## Input Files

All input files should be in Parquet format in the `input/` directory:

### 1. reptdate.parquet
- **Description**: Report date file
- **Columns**: 
  - `REPTDATE` (date): The report date
- **Purpose**: Source for all date-related macro variables and validation

### 2. sme08.parquet
- **Description**: SME (Small and Medium Enterprise) data
- **Columns**: Various SME-related columns (schema flexible)
- **Purpose**: Data to be copied to output if date validation passes

## Output Files

All output files are generated in the `output/` directory:

### 1. reptdate.parquet
- **Description**: Copy of report date for downstream processing
- **Columns**: Same as input `REPTDATE`

### 2. sme08.parquet
- **Description**: Copy of SME08 data (only if date validation passes)
- **Columns**: Same as input `SME08`

### 3. LALWPBBC outputs (if processing succeeds)
- Various output files generated by LALWPBBC processing
- Filename pattern: `lalwpbbc_*.parquet` or other formats

## Processing Logic

### Date Validation Flow

```
1. Read REPTDATE
   ↓
2. Extract REPTDATE date → RDATE
   ↓
3. Read REPTDATE again → LOAN date
   ↓
4. Compare: LOAN == RDATE?
   ├─ YES: Continue processing
   │   ├─ Copy SME08 data
   │   ├─ Execute LALWPBBC
   │   └─ Exit with code 0 (success)
   │
   └─ NO: Abort processing
       ├─ Print error message
       └─ Exit with code 77 (date mismatch)
```

### Conditional Processing Macro

```sas
/* SAS */
%MACRO PROCESS;
   %IF "&LOAN"="&RDATE" %THEN %DO;
      DATA BNM.SME08; SET BNM1.SME08; RUN;
      %INC PGM(LALWPBBC);
   %END;
   %ELSE %DO;
      %PUT THE LOAN EXTRACTION IS NOT DATED &RDATE;
      %PUT THE JOB IS NOT DONE !!;
      DATA A; ABORT 77; %END;
   %END;
%MEND;
```

**Python Equivalent:**
```python
loan_date = get_loan_date()
rdate = macro_vars['RDATE']

if loan_date == rdate:
    copy_sme08()
    execute_lalwpbbc()
    sys.exit(0)
else:
    print(f"THE LOAN EXTRACTION IS NOT DATED {rdate}")
    print("THE JOB IS NOT DONE !!")
    sys.exit(77)
```

## Exit Codes

| Code | Meaning | Description |
|------|---------|-------------|
| 0 | Success | Date validation passed, processing completed |
| 77 | Date Mismatch | LOAN date ≠ RDATE, processing aborted |
| 1 | General Error | Exception occurred during processing |

## Macro Variables

Extracted from REPTDATE and available for downstream processing:

| Variable | SAS Format | Description | Example |
|----------|------------|-------------|---------|
| NOWK | Z2. | Day of month (zero-padded) | `15` |
| REPTMON | Z2. | Month (zero-padded) | `02` |
| REPTYEAR | YEAR4. | Four-digit year | `2024` |
| RDATE | DDMMYY8. | Formatted date | `15/02/2024` |
| SDATE | DDMMYY8. | Same as RDATE | `15/02/2024` |
| TDATE | Z5. | Date timestamp (YMMDD) | `40215` |

### TDATE Format Explanation

The TDATE format is Z5. which represents the date as a 5-digit zero-padded number in YMMDD format:
- Position 1: Last digit of year (4 for 2024, 5 for 2025)
- Positions 2-3: Month (01-12)
- Positions 4-5: Day (01-31)

Example: February 15, 2024 → `40215`

## Usage

```bash
python eibdwklx_processing.py
```

### Directory Structure

```
.
├── input/
│   ├── reptdate.parquet
│   └── sme08.parquet
├── output/
│   ├── reptdate.parquet (generated)
│   ├── sme08.parquet (generated if validation passes)
│   └── lalwpbbc_*.* (generated by LALWPBBC if validation passes)
├── eibdwklx_processing.py
└── lalwpbbc_processing.py (required for full processing)
```

## LALWPBBC Integration

The program executes an external Python script `lalwpbbc_processing.py` which represents the SAS `%INC PGM(LALWPBBC)` logic.

### LALWPBBC Script Requirements

The `lalwpbbc_processing.py` script should:
1. Read data from the `input/` directory
2. Process loan and advance data according to LALWPBBC specifications
3. Write outputs to the `output/` directory
4. Return exit code 0 on success, non-zero on failure

### Stub Implementation

A stub implementation is provided that:
- Prints processing messages
- Creates a dummy output file
- Returns success code

**Replace the stub with the actual LALWPBBC conversion when available.**

## Key Features

### 1. Strict Date Validation
- Reads REPTDATE twice to ensure consistency
- Compares LOAN extraction date with expected RDATE
- Aborts with specific exit code (77) if mismatch

### 2. Conditional Execution
- Only processes data if date validation passes
- Prevents downstream errors from stale data
- Provides clear error messages

### 3. Macro Variable Generation
- Extracts multiple date formats from single source
- Makes dates available for downstream processing
- Follows SAS format conventions exactly

### 4. External Program Integration
- Executes LALWPBBC processing as separate script
- Captures output and errors
- Propagates failure status

### 5. Clean Exit Codes
- Exit 0: Success
- Exit 77: Date mismatch (matches SAS ABORT 77)
- Exit 1: General error

## Error Scenarios

### Scenario 1: Date Mismatch
```
LOAN extraction date: 14/02/2024
Expected date (RDATE): 15/02/2024

✗ Date validation failed!
  THE LOAN EXTRACTION IS NOT DATED 15/02/2024
  THE JOB IS NOT DONE !!
  
Exit code: 77
```

### Scenario 2: Missing REPTDATE File
```
✗ Error: REPTDATE file not found: input/reptdate.parquet

Exit code: 1
```

### Scenario 3: LALWPBBC Failure
```
Executing LALWPBBC processing...
✗ Error in LALWPBBC: ...
RuntimeError: LALWPBBC processing failed with code 1

Exit code: 1
```

### Scenario 4: Success
```
✓ Date validation passed: LOAN=15/02/2024, RDATE=15/02/2024
✓ SME08 copied
✓ LALWPBBC processing completed
✓ Program completed successfully

Exit code: 0
```

## Processing Steps

### Step 1: Process REPTDATE (First Pass)
```python
# Read REPTDATE
reptdate = df['REPTDATE'][0]

# Extract components
wk = reptdate.day
mm = reptdate.month
year = reptdate.year

# Create macro variables
NOWK = f"{wk:02d}"
REPTMON = f"{mm:02d}"
REPTYEAR = str(year)
RDATE = f"{reptdate.day:02d}/{reptdate.month:02d}/{year}"
# etc.
```

### Step 2: Get LOAN Date (Second Pass)
```python
# Read REPTDATE again
reptdate = df['REPTDATE'][0]

# Format as DDMMYY8
LOAN = f"{reptdate.day:02d}/{reptdate.month:02d}/{reptdate.year}"
```

### Step 3: Validate Dates
```python
if LOAN == RDATE:
    proceed_with_processing()
else:
    abort_with_error_code_77()
```

### Step 4: Copy SME08 (if validation passes)
```python
sme08 = pl.read_parquet(SME08_FILE)
sme08.write_parquet(SME08_OUTPUT)
```

### Step 5: Execute LALWPBBC (if validation passes)
```python
subprocess.run(['python3', 'lalwpbbc_processing.py'])
```

## Differences from SAS/JCL

| Feature | SAS/JCL | Python |
|---------|---------|--------|
| **File Format** | SAS datasets | Parquet files |
| **Macro Variables** | `%LET` / `CALL SYMPUT` | Dictionary |
| **Conditional Execution** | `%MACRO` / `%IF` | Python if-else |
| **External Program** | `%INC PGM()` | `subprocess.run()` |
| **Abort** | `ABORT 77` | `sys.exit(77)` |
| **Data Copy** | `DATA ... SET` | `read/write_parquet()` |
| **Date Formats** | SAS formats | Python string formatting |

## SAS Format Conversions

| SAS Format | Python Equivalent | Example |
|------------|-------------------|---------|
| `Z2.` | `f"{value:02d}"` | `15` |
| `YEAR4.` | `str(year)` | `2024` |
| `DDMMYY8.` | `f"{day:02d}/{month:02d}/{year}"` | `15/02/2024` |
| `Z5.` | `f"{year%10}{month:02d}{day:02d}"` | `40215` |

## Troubleshooting

| Issue | Solution |
|-------|----------|
| **Exit code 77** | Check that LOAN extraction date matches REPTDATE |
| **LALWPBBC not found** | Ensure `lalwpbbc_processing.py` exists in same directory |
| **REPTDATE missing** | Verify input/reptdate.parquet exists |
| **SME08 missing** | File is optional, processing continues with warning |
| **Permission error** | Check write permissions on output/ directory |

## Validation Checklist

After running:
- [ ] Exit code is 0 (success) or 77 (date mismatch)
- [ ] reptdate.parquet created in output/
- [ ] If dates match: sme08.parquet created in output/
- [ ] If dates match: LALWPBBC outputs created
- [ ] If dates don't match: Error message printed
- [ ] Macro variables displayed in console output

## Integration Notes

### Upstream Dependency: EIBDLNEX
This program must run AFTER EIBDLNEX completes successfully. EIBDLNEX is responsible for:
- Extracting loan data
- Creating the REPTDATE file
- Populating SME08 data

### Downstream Processing
The outputs of this program (particularly from LALWPBBC) are typically used by:
- Reporting programs
- Regulatory submission processes
- Data warehouse loads

## Performance Notes

- **Polars**: Fast Parquet I/O
- **No Sorting**: No unnecessary PROC SORT operations
- **Minimal Processing**: Only copies data if validation passes
- **Early Exit**: Aborts immediately on date mismatch
- **Subprocess**: LALWPBBC runs in separate process

## Example Output

### Successful Run
```
EIBDWKLX - Loan Data Processing with Date Validation
================================================================================
ESMR: 06-1428
Run after: EIBDLNEX
================================================================================

1. Processing REPTDATE and extracting macro variables...

   Macro Variables:
     NOWK (day): 15
     REPTMON (month): 02
     REPTYEAR (year): 2024
     RDATE (formatted): 15/02/2024
     SDATE (formatted): 15/02/2024
     TDATE (timestamp): 40215

================================================================================
CONDITIONAL PROCESSING
================================================================================

Validating dates...
  LOAN extraction: 15/02/2024
  Report date (RDATE): 15/02/2024

✓ Dates match - proceeding with processing
--------------------------------------------------------------------------------

1. Copying SME08 data...
  Records: 1,234
  ✓ SME08 copied to output/sme08.parquet

2. Executing LALWPBBC processing...
================================================================================
LALWPBBC Processing
(processing output...)
✓ LALWPBBC processing completed successfully
================================================================================

✓ Processing completed successfully

================================================================================
PROCESSING SUMMARY
================================================================================

Date Information:
  Week (NOWK): 15
  Month (REPTMON): 02
  Year (REPTYEAR): 2024
  Report Date (RDATE): 15/02/2024
  Start Date (SDATE): 15/02/2024
  Timestamp (TDATE): 40215

Generated Files:
  - output/reptdate.parquet
  - output/sme08.parquet (1,234 bytes)

✓ Program completed successfully
```

### Failed Run (Date Mismatch)
```
EIBDWKLX - Loan Data Processing with Date Validation
================================================================================
...

✗ Date validation failed!
  LOAN extraction date: 14/02/2024
  Expected date (RDATE): 15/02/2024

✗ Dates do not match - aborting processing
  THE LOAN EXTRACTION IS NOT DATED 15/02/2024
  THE JOB IS NOT DONE !!
================================================================================

✗ Program exiting with code 77
```
